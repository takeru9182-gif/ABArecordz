<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>ABAè¨˜éŒ²ãƒ„ãƒ¼ãƒ«ï¼ˆæ¨ªä¸¦ã³â—¯âœ•Pè¡¨ãƒ»å®‰å®šç‰ˆï¼‰</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    :root {
      --primary: #1976d2;
      --primary-soft: #e3f2fd;
      --bg: #f3f4f6;
      --card-bg: #ffffff;
      --danger: #e53935;
      --success: #43a047;
      --text-main: #222;
      --text-sub: #666;
      --border-soft: #e0e0e0;
    }
    * { box-sizing: border-box; }
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      margin: 0;
      padding: 16px;
      background: var(--bg);
      color: var(--text-main);
    }
    .app-container { max-width: 980px; margin: 0 auto; }
    h1 { font-size: 22px; margin-bottom: 4px; text-align: center; }
    .subtitle { text-align: center; font-size: 12px; color: var(--text-sub); margin-bottom: 16px; }
    .card {
      background: var(--card-bg);
      border-radius: 16px;
      padding: 14px 16px 16px;
      margin-bottom: 14px;
      border: 1px solid #e5e7eb;
      box-shadow: 0 4px 10px rgba(0,0,0,0.04);
    }
    .card-header { display: flex; align-items: baseline; justify-content: space-between; margin-bottom: 4px; }
    .card-title { font-size: 15px; font-weight: 600; display: flex; align-items: center; gap: 6px; }
    .card-title span.emoji { font-size: 18px; }
    .card-description { font-size: 11px; color: var(--text-sub); margin-bottom: 8px; }
    label { font-size: 13px; display: block; margin-top: 6px; margin-bottom: 2px; }
    input, select {
      width: 100%; padding: 6px 9px; font-size: 13px;
      border-radius: 8px; border: 1px solid var(--border-soft); background: #fafafa;
    }
    input:focus, select:focus {
      outline: none; border-color: var(--primary); background: #ffffff;
      box-shadow: 0 0 0 2px rgba(25,118,210,0.12);
    }
    .row { display: flex; gap: 10px; margin-top: 6px; flex-wrap: wrap; }
    .row > div { flex: 1; min-width: 150px; }
    .btn {
      display: inline-flex; align-items: center; justify-content: center;
      gap: 4px; padding: 7px 12px; font-size: 13px;
      border-radius: 999px; border: none; cursor: pointer;
      margin-right: 8px; white-space: nowrap;
    }
    .btn-primary { background: #1976d2; color: #fff; }
    .btn-outline { background: #fff; color: #1976d2; border: 1px solid #e3f2fd; }
    .btn-success { background: var(--success); color: #fff; }
    .btn-fail { background: var(--danger); color: #fff; }
    .btn-prompt { background: #ffb300; color: #222; }
    .btn-save { background: #1976d2; color: #fff; width: 100%; margin-top: 10px; padding: 9px 14px; font-weight: 600; }
    .btn-small { padding: 5px 10px; font-size: 11px; }
    .btn-danger { background: #fff5f5; color: #e53935; border: 1px solid #ffcdd2; }
    .tags-inline { font-size: 12px; min-height: 20px; color: var(--text-sub); }
    .pill {
      display: inline-block; border-radius: 999px; padding: 3px 9px;
      font-size: 11px; background: #e3f2fd; color: #1976d2; margin: 2px;
    }
    .tag {
      display: inline-block; font-size: 11px; padding: 2px 6px;
      border-radius: 999px; background: #e5e7eb; margin-right: 4px; margin-bottom: 2px;
    }
    .session-list-item {
      border-bottom: 1px solid #f0f0f0; padding: 6px 0 10px; font-size: 12px;
    }
    .session-meta { display: flex; justify-content: space-between; flex-wrap: wrap; gap: 4px; }
    .session-main { margin-top: 2px; color: var(--text-sub); }
    .trial-list {
      font-size: 18px; letter-spacing: 2px; min-height: 24px; padding: 4px 0;
    }
    .trial-list-empty { font-size: 11px; color: #888; }
    .trial-table-wrapper { margin-top: 4px; overflow-x: auto; }
    .trial-table { border-collapse: collapse; font-size: 11px; }
    .trial-table th, .trial-table td {
      border: 1px solid #eee; padding: 2px 4px; text-align: center; white-space: nowrap;
    }
    .trial-table th { background: #fafafa; }
    .kpi-row { display: flex; flex-wrap: wrap; gap: 8px; margin-top: 8px; }
    .kpi-card {
      flex: 1; min-width: 130px; background: #f9fafb;
      border-radius: 12px; padding: 8px 10px; border: 1px solid #e5e7eb;
    }
    .kpi-label { font-size: 11px; color: var(--text-sub); margin-bottom: 2px; }
    .kpi-value { font-size: 16px; font-weight: 600; }
    .kpi-sub { font-size: 11px; color: var(--text-sub); margin-top: 2px; }
    .progress-bar {
      width: 100%; height: 10px; border-radius: 999px; background: #eceff1;
      overflow: hidden; margin-top: 4px;
    }
    .progress-fill {
      height: 100%; background: linear-gradient(90deg, #4caf50, #81c784);
      width: 0%; transition: width 0.2s ease-out;
    }
    .summary-table {
      width: 100%; border-collapse: collapse; font-size: 12px; margin-top: 8px;
    }
    .summary-table th, .summary-table td {
      border: 1px solid #eee; padding: 4px 6px; text-align: center;
    }
    .summary-table th { background: #fafafa; }
    .export-row {
      margin-top: 8px; display: flex; flex-wrap: wrap; gap: 8px; align-items: center;
    }
    .export-row input[type="file"] { padding: 0; border: none; background: transparent; }
    .note-text { font-size: 11px; color: var(--text-sub); margin-top: 4px; }
    @media (max-width: 640px) {
      .card { border-radius: 14px; padding: 12px 12px 14px; }
      .btn { margin-bottom: 4px; }
      .btn-save { margin-top: 8px; }
    }
  </style>
</head>
<body>

<div class="app-container">
  <h1>ABAè¨˜éŒ²ãƒ„ãƒ¼ãƒ«ï¼ˆè©¦ä½œç‰ˆï¼‰</h1>
  <div class="subtitle">
    ABAç™‚è‚²ã‚»ãƒƒã‚·ãƒ§ãƒ³ã®ã€ŒæˆåŠŸ / å¤±æ•— / ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ(P)ã€ã‚’è¨˜éŒ²ã—ã€<br>
    ç”Ÿå¾’ã”ã¨ã®æˆé•·ã¨å„ãƒˆãƒ©ã‚¤ã‚¢ãƒ«ã®å±¥æ­´ã‚’ã‚°ãƒ©ãƒ•ã¨æ¨ªä¸¦ã³ã®è¡¨ã§ç¢ºèªã§ãã¾ã™ã€‚
  </div>

  <!-- ç”Ÿå¾’ãƒ»ã‚»ã‚¯ã‚·ãƒ§ãƒ³ç®¡ç† -->
  <div class="card">
    <div class="card-header">
      <div class="card-title"><span class="emoji">ğŸ“š</span><span>â‘  ç”Ÿå¾’ãƒ»ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã®ç®¡ç†</span></div>
    </div>
    <div class="card-description">
      ã¾ãšã¯ã€è¨˜éŒ²å¯¾è±¡ã¨ãªã‚‹ã€Œç”Ÿå¾’ã€ã¨ã€Œã‚»ã‚¯ã‚·ãƒ§ãƒ³ï¼ˆã‚¿ãƒ¼ã‚²ãƒƒãƒˆè¡Œå‹•ï¼‰ã€ã‚’ç™»éŒ²ã—ã¾ã™ã€‚
    </div>

    <div class="row">
      <div>
        <label>ç”Ÿå¾’åã®è¿½åŠ </label>
        <div class="row">
          <div style="flex:2;">
            <input id="newStudentName" placeholder="ä¾‹ï¼šAãã‚“">
          </div>
          <div style="flex:1; display:flex; align-items:center;">
            <button class="btn btn-outline" style="width:100%;" onclick="addStudent()">ç”Ÿå¾’ã‚’ç™»éŒ²</button>
          </div>
        </div>
      </div>
      <div>
        <label>ã‚»ã‚¯ã‚·ãƒ§ãƒ³ï¼ˆã‚¿ãƒ¼ã‚²ãƒƒãƒˆè¡Œå‹•ï¼‰ã®è¿½åŠ </label>
        <div class="row">
          <div style="flex:2;">
            <input id="newSectionName" placeholder="ä¾‹ï¼šè¦æ±‚ã®è¡¨å‡º">
          </div>
          <div style="flex:1; display:flex; align-items:center;">
            <button class="btn btn-outline" style="width:100%;" onclick="addSection()">ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’ç™»éŒ²</button>
          </div>
        </div>
      </div>
    </div>

    <div class="row" style="margin-top:10px;">
      <div>
        <label>ç™»éŒ²æ¸ˆã¿ã®ç”Ÿå¾’</label>
        <div id="studentList" class="tags-inline"></div>
        <div class="row" style="margin-top:6px;">
          <div>
            <label style="font-size:11px;">ç”Ÿå¾’å‰Šé™¤ï¼ˆï¼‹è©²å½“ãƒ‡ãƒ¼ã‚¿ã‚‚å‰Šé™¤ï¼‰</label>
            <select id="deleteStudentSelect">
              <option value="">ç”Ÿå¾’ã‚’é¸æŠ</option>
            </select>
          </div>
          <div style="display:flex; align-items:flex-end;">
            <button class="btn btn-small btn-danger" onclick="deleteStudentMaster()">ç”Ÿå¾’ã‚’å‰Šé™¤</button>
          </div>
        </div>
      </div>
      <div>
        <label>ç™»éŒ²æ¸ˆã¿ã®ã‚»ã‚¯ã‚·ãƒ§ãƒ³</label>
        <div id="sectionList" class="tags-inline"></div>
        <div class="row" style="margin-top:6px;">
          <div>
            <label style="font-size:11px;">ã‚»ã‚¯ã‚·ãƒ§ãƒ³å‰Šé™¤ï¼ˆï¼‹è©²å½“ãƒ‡ãƒ¼ã‚¿ã‚‚å‰Šé™¤ï¼‰</label>
            <select id="deleteSectionSelect">
              <option value="">ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’é¸æŠ</option>
            </select>
          </div>
          <div style="display:flex; align-items:flex-end;">
            <button class="btn btn-small btn-danger" onclick="deleteSectionMaster()">ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’å‰Šé™¤</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- ã‚»ãƒƒã‚·ãƒ§ãƒ³è¨˜éŒ² -->
  <div class="card">
    <div class="card-header">
      <div class="card-title"><span class="emoji">âœï¸</span><span>â‘¡ ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’è¨˜éŒ²</span></div>
    </div>
    <div class="card-description">
      ç”Ÿå¾’ã¨ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’é¸ã³ã€ãƒˆãƒ©ã‚¤ã‚¢ãƒ«ã”ã¨ã«ã€Œâ—¯ / âœ• / Pã€ã‚’æŠ¼ã—ã¦è¨˜éŒ²ã—ã¾ã™ã€‚<br>
      æˆåŠŸç‡ã¯ã€Œâ—¯ Ã· ï¼ˆâ—¯ï¼‹âœ•ï¼‹Pï¼‰ã€ã§è¨ˆç®—ã—ã¦ã„ã¾ã™ã€‚
    </div>

    <div class="row">
      <div>
        <label>ç”Ÿå¾’ã‚’é¸æŠ</label>
        <select id="childSelect">
          <option value="">ç”Ÿå¾’ã‚’é¸æŠã—ã¦ãã ã•ã„</option>
        </select>
      </div>
      <div>
        <label>ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’é¸æŠ</label>
        <select id="sectionSelect">
          <option value="">ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’é¸æŠã—ã¦ãã ã•ã„</option>
        </select>
      </div>
    </div>

    <div class="row">
      <div>
        <label>ãƒˆãƒ©ã‚¤ã‚¢ãƒ«ç›®æ¨™å›æ•°</label>
        <input id="trialGoal" type="number" value="10" min="1" max="30">
      </div>
      <div>
        <label>ç¾åœ¨ã®å›æ•°</label>
        <div id="trialCountDisplay" style="font-size:13px; font-weight:600;">0 å›</div>
      </div>
    </div>

    <label style="margin-top:10px;">ãƒˆãƒ©ã‚¤ã‚¢ãƒ«å…¥åŠ›</label>
    <div class="row" style="margin-top:4px;">
      <div style="flex:1; min-width:100px;">
        <button class="btn btn-success" style="width:100%;" onclick="addTrial('â—¯')">æˆåŠŸï¼ˆâ—¯ï¼‰</button>
      </div>
      <div style="flex:1; min-width:100px;">
        <button class="btn btn-fail" style="width:100%;" onclick="addTrial('âœ•')">å¤±æ•—ï¼ˆâœ•ï¼‰</button>
      </div>
      <div style="flex:1; min-width:100px;">
        <button class="btn btn-prompt" style="width:100%;" onclick="addTrial('P')">Pï¼ˆãƒ—ãƒ­ãƒ³ãƒ—ãƒˆï¼‰</button>
      </div>
    </div>

    <div style="margin-top:8px;">
      <label>ä»Šå›ã‚»ãƒƒã‚·ãƒ§ãƒ³ã®â—¯âœ•Pãƒªã‚¹ãƒˆ</label>
      <div id="trialList" class="trial-list trial-list-empty">
        ã¾ã å…¥åŠ›ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚
      </div>
    </div>

    <div class="kpi-row">
      <div class="kpi-card">
        <div class="kpi-label">ç¾åœ¨ã®æˆåŠŸç‡</div>
        <div class="kpi-value" id="kpiRate">0%</div>
        <div class="progress-bar">
          <div class="progress-fill" id="kpiProgress"></div>
        </div>
        <div class="kpi-sub" id="kpiDetail">æˆåŠŸ 0 å› / 0 å›ä¸­</div>
      </div>
      <div class="kpi-card">
        <div class="kpi-label">ãƒˆãƒ©ã‚¤ã‚¢ãƒ«çŠ¶æ³</div>
        <div class="kpi-value" id="kpiCount">0 / 0</div>
        <div class="kpi-sub">ç›®æ¨™å›æ•°ã«å¯¾ã™ã‚‹ç¾æ™‚ç‚¹ã®é€²ã¿å…·åˆã§ã™ã€‚</div>
      </div>
    </div>

    <button class="btn btn-save" onclick="saveSession()">ã“ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’ä¿å­˜</button>
  </div>

  <!-- éå»ãƒ‡ãƒ¼ã‚¿ & ãƒ•ã‚£ãƒ«ã‚¿ -->
  <div class="card">
    <div class="card-header">
      <div class="card-title"><span class="emoji">ğŸ“‹</span><span>â‘¢ éå»ãƒ‡ãƒ¼ã‚¿ & ãƒ•ã‚£ãƒ«ã‚¿</span></div>
    </div>
    <div class="card-description">
      ç”Ÿå¾’ãƒ»ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã§çµã‚Šè¾¼ã‚“ã§ã€éå»ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ä¸€è¦§ã¨ã‚°ãƒ©ãƒ•ã‚’è¡¨ç¤ºãƒ»å‰Šé™¤ã§ãã¾ã™ã€‚<br>
      å„ã‚»ãƒƒã‚·ãƒ§ãƒ³ã®â—¯âœ•Pã®ä¸¦ã³ã¯ã€Œæ¨ªä¸¦ã³ã®è¡¨å½¢å¼ã€ã§ç¢ºèªã§ãã¾ã™ã€‚
    </div>

    <div class="row">
      <div>
        <label>è¡¨ç¤ºã™ã‚‹ç”Ÿå¾’</label>
        <select id="filterChild">
          <option value="">å…¨ã¦ã®ç”Ÿå¾’</option>
        </select>
      </div>
      <div>
        <label>ã‚»ã‚¯ã‚·ãƒ§ãƒ³</label>
        <select id="filterSection">
          <option value="">å…¨ã¦ã®ã‚»ã‚¯ã‚·ãƒ§ãƒ³</option>
        </select>
      </div>
    </div>

    <div style="margin-top:8px; display:flex; flex-wrap:wrap; gap:6px;">
      <button class="btn btn-small btn-primary" onclick="applyFilter()">ãƒ•ã‚£ãƒ«ã‚¿é©ç”¨ & ã‚°ãƒ©ãƒ•æ›´æ–°</button>
      <button class="btn btn-small btn-danger" onclick="deleteFilteredData()">ãƒ•ã‚£ãƒ«ã‚¿æ¡ä»¶ã®ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤</button>
    </div>

    <h3 style="font-size:13px; margin-top:12px; margin-bottom:4px;">ã‚»ãƒƒã‚·ãƒ§ãƒ³ä¸€è¦§</h3>
    <div id="sessionList"></div>
  </div>

  <!-- ã‚°ãƒ©ãƒ• -->
  <div class="card">
    <div class="card-header">
      <div class="card-title"><span class="emoji">ğŸ“ˆ</span><span>ã‚»ãƒƒã‚·ãƒ§ãƒ³ã”ã¨ã®æˆåŠŸç‡ã®æ¨ç§»</span></div>
    </div>
    <div class="card-description">
      é¸æŠã—ãŸç”Ÿå¾’ãƒ»ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã®ã€1å›ã”ã¨ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³æˆåŠŸç‡ã®å¤‰åŒ–ã§ã™ã€‚
    </div>
    <div id="currentGraphRate" style="font-size:12px; margin:0 0 4px 0; color:var(--text-main); font-weight:500;">
      æœ€æ–°ã‚»ãƒƒã‚·ãƒ§ãƒ³ã®æˆåŠŸç‡ï¼š- %
    </div>
    <canvas id="sessionChart" height="210"></canvas>
  </div>

  <div class="card">
    <div class="card-header">
      <div class="card-title"><span class="emoji">ğŸ§‘â€ğŸ“</span><span>ç”Ÿå¾’åˆ¥ã‚µãƒãƒªãƒ¼</span></div>
    </div>
    <div class="card-description">
      ç¾åœ¨ã®ãƒ•ã‚£ãƒ«ã‚¿æ¡ä»¶ã«è©²å½“ã™ã‚‹ãƒ‡ãƒ¼ã‚¿ã‚’ã€ç”Ÿå¾’ã”ã¨ã«ã¾ã¨ã‚ã¦è¡¨ç¤ºã—ã¾ã™ã€‚
    </div>
    <canvas id="studentChart" height="220"></canvas>
    <div id="studentSummary"></div>
  </div>

  <!-- ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ / ã‚¤ãƒ³ãƒãƒ¼ãƒˆ -->
  <div class="card">
    <div class="card-header">
      <div class="card-title"><span class="emoji">ğŸ’¾</span><span>â‘£ ãƒ‡ãƒ¼ã‚¿ã®ä¿å­˜ï¼ˆãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ï¼‰ / èª­ã¿è¾¼ã¿</span></div>
    </div>
    <div class="card-description">
      å¿…è¦ã«å¿œã˜ã¦ã€ãƒ‡ãƒ¼ã‚¿ã‚’JSONãƒ•ã‚¡ã‚¤ãƒ«ã¨ã—ã¦ä¿å­˜ãƒ»èª­ã¿è¾¼ã¿ã§ãã¾ã™ã€‚
    </div>

    <div class="export-row">
      <button class="btn btn-small btn-primary" onclick="exportData()">ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆï¼ˆJSONä¿å­˜ï¼‰</button>
      <span class="note-text">â€»JSONãƒ•ã‚¡ã‚¤ãƒ«ã¨ã—ã¦ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã•ã‚Œã¾ã™ã€‚</span>
    </div>

    <div class="export-row">
      <input id="importFile" type="file" accept="application/json">
      <button class="btn btn-small btn-outline" onclick="importData()">ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆ</button>
    </div>

    <div class="note-text">
      ãƒ»PC/iPhoneã”ã¨ã«ãƒ‡ãƒ¼ã‚¿ã¯åˆ¥ç®¡ç†ã§ã™ã€‚<br>
      ãƒ»ç«¯æœ«ã‚’å¤‰ãˆã‚‹ã¨ãã¯ã€ä¸€åº¦ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã—ã€æ–°ã—ã„ç«¯æœ«ã§ã‚¤ãƒ³ãƒãƒ¼ãƒˆã—ã¦ãã ã•ã„ã€‚<br>
      ãƒ»ã‚¤ãƒ³ãƒãƒ¼ãƒˆæ™‚ã¯æ—¢å­˜ãƒ‡ãƒ¼ã‚¿ã«ã€Œä¸Šæ›¸ãã€ã•ã‚Œã¾ã™ã€‚
    </div>
  </div>

</div> <!-- /app-container -->

<script>
  // ãƒ‡ãƒ¼ã‚¿ä¿æŒç”¨
  var currentTrials = [];   // ['â—¯','âœ•','P', ...]
  var sessions = [];
  var students = [];
  var sections = [];
  var sessionChart = null;
  var studentChart = null;

  var STORAGE_KEY_SESSIONS = "ABA_SESSIONS_V2_MARKS";
  var STORAGE_KEY_STUDENTS = "ABA_STUDENTS_V1";
  var STORAGE_KEY_SECTIONS = "ABA_SECTIONS_V1";

  function loadFromStorage() {
    try {
      var rawSessions = localStorage.getItem(STORAGE_KEY_SESSIONS);
      sessions = rawSessions ? JSON.parse(rawSessions) : [];
    } catch (e) { sessions = []; }

    try {
      var rawStudents = localStorage.getItem(STORAGE_KEY_STUDENTS);
      students = rawStudents ? JSON.parse(rawStudents) : [];
    } catch (e) { students = []; }

    try {
      var rawSections = localStorage.getItem(STORAGE_KEY_SECTIONS);
      sections = rawSections ? JSON.parse(rawSections) : [];
    } catch (e) { sections = []; }

    cleanupOrphanSessions();
  }

  function saveSessionsToStorage() {
    localStorage.setItem(STORAGE_KEY_SESSIONS, JSON.stringify(sessions));
  }
  function saveStudentsToStorage() {
    localStorage.setItem(STORAGE_KEY_STUDENTS, JSON.stringify(students));
  }
  function saveSectionsToStorage() {
    localStorage.setItem(STORAGE_KEY_SECTIONS, JSON.stringify(sections));
  }

  function cleanupOrphanSessions() {
    var validChildren = {};
    var validSections = {};
    students.forEach(function(s){ validChildren[s] = true; });
    sections.forEach(function(s){ validSections[s] = true; });

    var before = sessions.length;
    sessions = sessions.filter(function(s) {
      return validChildren[s.child] && validSections[s.section];
    });
    if (sessions.length !== before) {
      saveSessionsToStorage();
    }
  }

  function addStudent() {
    var name = document.getElementById("newStudentName").value.trim();
    if (!name) { alert("ç”Ÿå¾’åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚"); return; }
    if (students.indexOf(name) !== -1) {
      alert("æ—¢ã«ç™»éŒ²æ¸ˆã¿ã®ç”Ÿå¾’ã§ã™ã€‚");
      return;
    }
    students.push(name);
    students.sort();
    saveStudentsToStorage();
    document.getElementById("newStudentName").value = "";
    renderStudentMaster();
    renderChildSelects();
  }

  function addSection() {
    var name = document.getElementById("newSectionName").value.trim();
    if (!name) { alert("ã‚»ã‚¯ã‚·ãƒ§ãƒ³åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚"); return; }
    if (sections.indexOf(name) !== -1) {
      alert("æ—¢ã«ç™»éŒ²æ¸ˆã¿ã®ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã§ã™ã€‚");
      return;
    }
    sections.push(name);
    sections.sort();
    saveSectionsToStorage();
    document.getElementById("newSectionName").value = "";
    renderSectionMaster();
    renderSectionSelects();
  }

  function deleteStudentMaster() {
    var name = document.getElementById("deleteStudentSelect").value;
    if (!name) { alert("å‰Šé™¤ã™ã‚‹ç”Ÿå¾’ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚"); return; }
    var count = sessions.filter(function(s){ return s.child === name; }).length;
    var ok = confirm(
      "ç”Ÿå¾’ã€Œ" + name + "ã€ã‚’å‰Šé™¤ã—ã¾ã™ã€‚\n" +
      "ã“ã®ç”Ÿå¾’ã«ç´ã¥ãã‚»ãƒƒã‚·ãƒ§ãƒ³ãƒ‡ãƒ¼ã‚¿ " + count + " ä»¶ã‚‚å‰Šé™¤ã•ã‚Œã¾ã™ã€‚\n" +
      "ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ"
    );
    if (!ok) return;

    students = students.filter(function(s){ return s !== name; });
    saveStudentsToStorage();

    sessions = sessions.filter(function(s){ return s.child !== name; });
    saveSessionsToStorage();

    cleanupOrphanSessions();
    renderStudentMaster();
    renderChildSelects();
    renderSessionList();
    updateSessionChart();
    updateStudentChart();

    document.getElementById("deleteStudentSelect").value = "";
    document.getElementById("childSelect").value = "";
    document.getElementById("filterChild").value = "";

    alert("ç”Ÿå¾’ã¨ã€ãã®ç”Ÿå¾’ã«ç´ã¥ããƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¾ã—ãŸã€‚");
  }

  function deleteSectionMaster() {
    var name = document.getElementById("deleteSectionSelect").value;
    if (!name) { alert("å‰Šé™¤ã™ã‚‹ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚"); return; }
    var count = sessions.filter(function(s){ return s.section === name; }).length;
    var ok = confirm(
      "ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã€Œ" + name + "ã€ã‚’å‰Šé™¤ã—ã¾ã™ã€‚\n" +
      "ã“ã®ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã«ç´ã¥ãã‚»ãƒƒã‚·ãƒ§ãƒ³ãƒ‡ãƒ¼ã‚¿ " + count + " ä»¶ã‚‚å‰Šé™¤ã•ã‚Œã¾ã™ã€‚\n" +
      "ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ"
    );
    if (!ok) return;

    sections = sections.filter(function(s){ return s !== name; });
    saveSectionsToStorage();

    sessions = sessions.filter(function(s){ return s.section !== name; });
    saveSessionsToStorage();

    cleanupOrphanSessions();
    renderSectionMaster();
    renderSectionSelects();
    renderSessionList();
    updateSessionChart();
    updateStudentChart();

    document.getElementById("deleteSectionSelect").value = "";
    document.getElementById("sectionSelect").value = "";
    document.getElementById("filterSection").value = "";

    alert("ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã¨ã€ãã®ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã«ç´ã¥ããƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¾ã—ãŸã€‚");
  }

  function renderStudentMaster() {
    var el = document.getElementById("studentList");
    if (students.length === 0) {
      el.textContent = "ã¾ã ç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚";
      return;
    }
    var html = "";
    students.forEach(function(s){
      html += '<span class="pill">' + s + '</span> ';
    });
    el.innerHTML = html;
  }

  function renderSectionMaster() {
    var el = document.getElementById("sectionList");
    if (sections.length === 0) {
      el.textContent = "ã¾ã ç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚";
      return;
    }
    var html = "";
    sections.forEach(function(s){
      html += '<span class="pill">' + s + '</span> ';
    });
    el.innerHTML = html;
  }

  function renderChildSelects() {
    var childSelect = document.getElementById("childSelect");
    var filterChild = document.getElementById("filterChild");
    var deleteStudentSelect = document.getElementById("deleteStudentSelect");

    childSelect.innerHTML = '<option value="">ç”Ÿå¾’ã‚’é¸æŠã—ã¦ãã ã•ã„</option>';
    filterChild.innerHTML = '<option value="">å…¨ã¦ã®ç”Ÿå¾’</option>';
    deleteStudentSelect.innerHTML = '<option value="">ç”Ÿå¾’ã‚’é¸æŠ</option>';

    students.forEach(function(s){
      var opt1 = document.createElement("option");
      opt1.value = s; opt1.textContent = s; childSelect.appendChild(opt1);
      var opt2 = document.createElement("option");
      opt2.value = s; opt2.textContent = s; filterChild.appendChild(opt2);
      var opt3 = document.createElement("option");
      opt3.value = s; opt3.textContent = s; deleteStudentSelect.appendChild(opt3);
    });
  }

  function renderSectionSelects() {
    var sectionSelect = document.getElementById("sectionSelect");
    var filterSection = document.getElementById("filterSection");
    var deleteSectionSelect = document.getElementById("deleteSectionSelect");

    sectionSelect.innerHTML = '<option value="">ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’é¸æŠã—ã¦ãã ã•ã„</option>';
    filterSection.innerHTML = '<option value="">å…¨ã¦ã®ã‚»ã‚¯ã‚·ãƒ§ãƒ³</option>';
    deleteSectionSelect.innerHTML = '<option value="">ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’é¸æŠ</option>';

    sections.forEach(function(s){
      var opt1 = document.createElement("option");
      opt1.value = s; opt1.textContent = s; sectionSelect.appendChild(opt1);
      var opt2 = document.createElement("option");
      opt2.value = s; opt2.textContent = s; filterSection.appendChild(opt2);
      var opt3 = document.createElement("option");
      opt3.value = s; opt3.textContent = s; deleteSectionSelect.appendChild(opt3);
    });
  }

  function addTrial(mark) {
    currentTrials.push(mark);
    updateSessionStats();
  }

  function updateSessionStats() {
    var total = currentTrials.length;
    var success = currentTrials.filter(function(m){ return m === "â—¯"; }).length;
    var rate = total === 0 ? 0 : Math.round((success / total) * 100);

    document.getElementById("trialCountDisplay").textContent = total + " å›";

    var kpiRate = document.getElementById("kpiRate");
    var kpiProgress = document.getElementById("kpiProgress");
    var kpiDetail = document.getElementById("kpiDetail");
    var kpiCount = document.getElementById("kpiCount");
    var goalRaw = document.getElementById("trialGoal").value;
    var goal = goalRaw ? parseInt(goalRaw, 10) : 0;

    kpiRate.textContent = rate + "%";
    kpiProgress.style.width = rate + "%";
    kpiDetail.textContent = "æˆåŠŸ " + success + " å› / " + total + " å›ä¸­";

    if (goal > 0) {
      kpiCount.textContent = total + " / " + goal;
    } else {
      kpiCount.textContent = total + " / -";
    }

    var trialListEl = document.getElementById("trialList");
    if (total === 0) {
      trialListEl.textContent = "ã¾ã å…¥åŠ›ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚";
      trialListEl.className = "trial-list trial-list-empty";
    } else {
      trialListEl.textContent = currentTrials.join(" ");
      trialListEl.className = "trial-list";
    }
  }

  function saveSession() {
    var child = document.getElementById("childSelect").value;
    var section = document.getElementById("sectionSelect").value;

    if (!child) { alert("ç”Ÿå¾’ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚"); return; }
    if (!section) { alert("ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚"); return; }
    if (currentTrials.length === 0) {
      alert("å°‘ãªãã¨ã‚‚1å›ã¯ãƒˆãƒ©ã‚¤ã‚¢ãƒ«ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚"); return;
    }

    var total = currentTrials.length;
    var success = currentTrials.filter(function(m){ return m === "â—¯"; }).length;
    var rate = total === 0 ? 0 : Math.round((success / total) * 100);
    var now = new Date();

    var session = {
      id: Date.now(),
      child: child,
      section: section,
      total: total,
      success: success,
      rate: rate,
      marks: currentTrials.slice(),
      datetime: now.toISOString()
    };

    sessions.push(session);
    saveSessionsToStorage();
    currentTrials = [];
    updateSessionStats();
    document.getElementById("trialCountDisplay").textContent = "0 å›";

    renderSessionList();
    updateSessionChart();
    updateStudentChart();

    alert("ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’ä¿å­˜ã—ã¾ã—ãŸã€‚");
  }

  function applyFilter() {
    renderSessionList();
    updateSessionChart();
    updateStudentChart();
  }

  function getFilteredSessions() {
    var fChild = document.getElementById("filterChild").value;
    var fSection = document.getElementById("filterSection").value;

    var result = sessions.filter(function(s){
      var childOk = fChild ? s.child === fChild : true;
      var sectOk = fSection ? s.section === fSection : true;
      return childOk && sectOk;
    });
    result.sort(function(a, b){
      return new Date(a.datetime) - new Date(b.datetime);
    });
    return result;
  }

  function deleteFilteredData() {
    var fChild = document.getElementById("filterChild").value;
    var fSection = document.getElementById("filterSection").value;

    if (!fChild && !fSection) {
      alert("å‰Šé™¤ã™ã‚‹å ´åˆã¯ã€å°‘ãªãã¨ã‚‚ç”Ÿå¾’ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚");
      return;
    }

    var targetSessions = getFilteredSessions();
    if (targetSessions.length === 0) {
      alert("å‰Šé™¤å¯¾è±¡ã®ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚");
      return;
    }

    var conditionText = fSection
      ? "ç”Ÿå¾’ã€Œ" + fChild + "ã€Ã— ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã€Œ" + fSection + "ã€"
      : "ç”Ÿå¾’ã€Œ" + fChild + "ã€ã®å…¨ã‚»ã‚¯ã‚·ãƒ§ãƒ³";

    var ok = confirm(
      conditionText + " ã®ãƒ‡ãƒ¼ã‚¿ã‚’ " +
      targetSessions.length + " ä»¶å‰Šé™¤ã—ã¾ã™ã€‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ"
    );
    if (!ok) return;

    sessions = sessions.filter(function(s){
      var childMatch = fChild ? s.child === fChild : true;
      var sectMatch = fSection ? s.section === fSection : true;
      return !(childMatch && sectMatch);
    });

    saveSessionsToStorage();
    renderSessionList();
    updateSessionChart();
    updateStudentChart();
    alert("å‰Šé™¤ãŒå®Œäº†ã—ã¾ã—ãŸã€‚");
  }

  function renderSessionList() {
    var listEl = document.getElementById("sessionList");
    var filtered = getFilteredSessions();

    if (filtered.length === 0) {
      listEl.innerHTML = "<div style='font-size:12px;color:#666;'>è©²å½“ã™ã‚‹ã‚»ãƒƒã‚·ãƒ§ãƒ³ãŒã‚ã‚Šã¾ã›ã‚“ã€‚</div>";
      return;
    }

    var html = "";
    filtered.forEach(function(s){
      var d = new Date(s.datetime);
      var dateStr = d.getFullYear() + "/" + (d.getMonth()+1) + "/" + d.getDate() + " " +
        ("0" + d.getHours()).slice(-2) + ":" + ("0" + d.getMinutes()).slice(-2);

      html += '<div class="session-list-item">';
      html +=   '<div class="session-meta">';
      html +=     '<div>';
      html +=       '<span class="tag">' + s.child + '</span>';
      html +=       '<span class="tag">' + s.section + '</span>';
      html +=     '</div>';
      html +=     '<div style="font-size:11px; color:#999;">' + dateStr + '</div>';
      html +=   '</div>';
      html +=   '<div class="session-main">';
      html +=     'æˆåŠŸ ' + s.success + ' / ' + s.total + ' å›ï¼ˆ' + s.rate + '%ï¼‰';
      html +=   '</div>';

      if (s.marks && s.marks.length > 0) {
        html += '<div class="trial-table-wrapper"><table class="trial-table">';
        html +=   '<thead><tr><th>å›</th>';
        for (var i = 0; i < s.marks.length; i++) {
          html += '<th>' + (i + 1) + '</th>';
        }
        html +=   '</tr></thead>';
        html +=   '<tbody><tr><th>çµæœ</th>';
        s.marks.forEach(function(mark){
          html += '<td>' + mark + '</td>';
        });
        html +=   '</tr></tbody>';
        html += '</table></div>';
      } else {
        html += '<div style="font-size:11px;color:#999;margin-top:4px;">ã“ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ã®â—¯âœ•Pè©³ç´°ã¯æœªä¿å­˜ã§ã™ã€‚</div>';
      }

      html += '</div>';
    });

    listEl.innerHTML = html;
  }

  function updateSessionChart() {
    var canvas = document.getElementById("sessionChart");
    if (!canvas) return;
    var ctx = canvas.getContext("2d");
    var filtered = getFilteredSessions();

    var labels = filtered.map(function(s){
      var d = new Date(s.datetime);
      return (d.getMonth()+1) + "/" + d.getDate();
    });
    var data = filtered.map(function(s){ return s.rate; });

    var currentLabel = document.getElementById("currentGraphRate");
    if (!filtered.length) {
      currentLabel.textContent = "æœ€æ–°ã‚»ãƒƒã‚·ãƒ§ãƒ³ã®æˆåŠŸç‡ï¼š- %";
    } else {
      var lastRate = filtered[filtered.length - 1].rate;
      currentLabel.textContent = "æœ€æ–°ã‚»ãƒƒã‚·ãƒ§ãƒ³ã®æˆåŠŸç‡ï¼š" + lastRate + "%";
    }

    if (typeof Chart === "undefined") {
      return;
    }

    if (sessionChart) {
      sessionChart.destroy();
    }

    sessionChart = new Chart(ctx, {
      type: "line",
      data: {
        labels: labels,
        datasets: [{
          label: "æˆåŠŸç‡ï¼ˆ%ï¼‰",
          data: data,
          fill: false,
          tension: 0.25
        }]
      },
      options: {
        plugins: { legend: { display: true } },
        scales: {
          y: {
            min: 0,
            max: 100,
            ticks: { stepSize: 20 }
          }
        }
      }
    });
  }

  function updateStudentChart() {
    var canvas = document.getElementById("studentChart");
    if (!canvas) return;
    var ctx = canvas.getContext("2d");
    var filtered = getFilteredSessions();

    var byChild = {};
    filtered.forEach(function(s){
      if (!byChild[s.child]) byChild[s.child] = [];
      byChild[s.child].push(s);
    });

    var labels = [];
    var avgRates = [];
    var speeds = [];

    for (var child in byChild) {
      if (!byChild.hasOwnProperty(child)) continue;
      var sess = byChild[child].slice().sort(function(a,b){
        return new Date(a.datetime) - new Date(b.datetime);
      });
      var n = sess.length;
      var sum = sess.reduce(function(acc, cur){ return acc + cur.rate; }, 0);
      var avg = n === 0 ? 0 : Math.round(sum / n);

      var first = sess[0].rate;
      var last = sess[n-1].rate;
      var delta = last - first;
      var speed = n > 1 ? (delta / (n-1)) : 0;

      labels.push(child);
      avgRates.push(avg);
      speeds.push(Math.round(speed * 10) / 10);
    }

    if (typeof Chart === "undefined") {
      return;
    }

    if (studentChart) {
      studentChart.destroy();
    }

    studentChart = new Chart(ctx, {
      type: "bar",
      data: {
        labels: labels,
        datasets: [
          { label: "å¹³å‡æˆåŠŸç‡ï¼ˆ%ï¼‰", data: avgRates },
          { label: "æˆé•·ã‚¹ãƒ”ãƒ¼ãƒ‰ï¼ˆ1ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚ãŸã‚Šã®å¤‰åŒ–ï¼‰", data: speeds }
        ]
      },
      options: {
        plugins: { legend: { display: true } },
        scales: { y: { beginAtZero: true, suggestedMax: 100 } }
      }
    });

    var summaryEl = document.getElementById("studentSummary");
    if (labels.length === 0) {
      summaryEl.innerHTML = "<div style='font-size:12px;color:#666;margin-top:8px;'>è©²å½“ã™ã‚‹ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚</div>";
      return;
    }

    var html = '<table class="summary-table"><thead><tr><th>ç”Ÿå¾’</th><th>ã‚»ãƒƒã‚·ãƒ§ãƒ³æ•°</th><th>å¹³å‡æˆåŠŸç‡ï¼ˆ%ï¼‰</th><th>æœ€åˆã®æˆåŠŸç‡</th><th>æœ€æ–°ã®æˆåŠŸç‡</th><th>æˆé•·ã‚¹ãƒ”ãƒ¼ãƒ‰</th></tr></thead><tbody>';
    var idx = 0;
    for (var child2 in byChild) {
      if (!byChild.hasOwnProperty(child2)) continue;
      var sess2 = byChild[child2].slice().sort(function(a,b){
        return new Date(a.datetime) - new Date(b.datetime);
      });
      var n2 = sess2.length;
      var first2 = sess2[0].rate;
      var last2 = sess2[n2-1].rate;
      var speed2 = speeds[idx];

      html += '<tr>' +
        '<td>' + child2 + '</td>' +
        '<td>' + n2 + '</td>' +
        '<td>' + avgRates[idx] + '</td>' +
        '<td>' + first2 + '</td>' +
        '<td>' + last2 + '</td>' +
        '<td>' + speed2 + '</td>' +
      '</tr>';
      idx++;
    }
    html += "</tbody></table>";
    summaryEl.innerHTML = html;
  }

  function exportData() {
    var data = {
      version: 2,
      exportedAt: new Date().toISOString(),
      students: students,
      sections: sections,
      sessions: sessions
    };
    var json = JSON.stringify(data, null, 2);
    var blob = new Blob([json], { type: "application/json" });
    var url = URL.createObjectURL(blob);

    var a = document.createElement("a");
    var now = new Date();
    var y = now.getFullYear();
    var m = ("0" + (now.getMonth() + 1)).slice(-2);
    var d = ("0" + now.getDate()).slice(-2);
    a.href = url;
    a.download = "aba_data_" + y + m + d + ".json";
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
  }

  function importData() {
    var input = document.getElementById("importFile");
    if (!input.files || input.files.length === 0) {
      alert("ã‚¤ãƒ³ãƒãƒ¼ãƒˆã™ã‚‹JSONãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚");
      return;
    }
    var file = input.files[0];
    var reader = new FileReader();
    reader.onload = function(e) {
      try {
        var text = e.target.result;
        var data = JSON.parse(text);

        if (!data || !Array.isArray(data.sessions) ||
            !Array.isArray(data.students) || !Array.isArray(data.sections)) {
          alert("ã‚¤ãƒ³ãƒãƒ¼ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã®å½¢å¼ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“ã€‚");
          return;
        }

        students = data.students;
        sections = data.sections;
        sessions = data.sessions;

        saveStudentsToStorage();
        saveSectionsToStorage();
        saveSessionsToStorage();

        renderStudentMaster();
        renderSectionMaster();
        renderChildSelects();
        renderSectionSelects();
        renderSessionList();
        updateSessionChart();
        updateStudentChart();

        alert("ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆã—ã¾ã—ãŸã€‚");
      } catch (err) {
        console.error(err);
        alert("JSONã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ãƒ•ã‚¡ã‚¤ãƒ«å†…å®¹ã‚’ã”ç¢ºèªãã ã•ã„ã€‚");
      } finally {
        input.value = "";
      }
    };
    reader.readAsText(file, "utf-8");
  }

  // åˆæœŸåŒ–
  loadFromStorage();
  renderStudentMaster();
  renderSectionMaster();
  renderChildSelects();
  renderSectionSelects();
  renderSessionList();
  updateSessionStats();
  updateSessionChart();
  updateStudentChart();
</script>

</body>
</html>
